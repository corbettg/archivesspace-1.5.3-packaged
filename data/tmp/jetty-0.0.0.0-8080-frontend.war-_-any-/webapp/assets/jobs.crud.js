$(function(){var b=function(){var f=$("#jobfileupload");var c;$(".btn:submit",f).on("click",function(j){j.stopPropagation();j.preventDefault();f.submit()});var i=function(){var j=document.createElement("input");j.setAttribute("multiple","true");return j.multiple===true};var g=function(){var k=$("#files");var j=function(){$(".hint",k).remove();var o=$(this);if(i()){$(this.files).each(function(p,r){var q=r.name.split("\\").reverse()[0];var s=$(AS.renderTemplate("template_import_file",{filename:q}));s.data("file",r);s.addClass("file-attached");o.val("");k.append(s)})}else{var l=o.val().split("\\").reverse()[0];var n=$(AS.renderTemplate("template_import_file",{filename:l}));n.append(o);var m=o.clone();m.on("change",j);$(".fileinput-button",f).append(m);k.append(n)}};$(":file",f).on("change",j);k.on("click",".btn-remove-file",function(){$(this).closest(".import-file").remove()});k.on("dragenter",function(l){l.stopPropagation();l.preventDefault();$(this).addClass("active")}).on("dragover",function(l){l.stopPropagation();l.preventDefault()}).on("dragleave",function(l){l.stopPropagation();l.preventDefault();$(this).removeClass("active")}).on("drop",function(l){$(this).removeClass("incoming").removeClass("active");$.each(l.originalEvent.dataTransfer.files,function(n,m){var o=$(AS.renderTemplate("template_import_file",{filename:m.name}));o.data("file",m);o.addClass("file-attached");k.append(o)})});$(document).on("dragenter",function(l){l.stopPropagation();l.preventDefault();k.addClass("incoming")}).on("dragover",function(l){l.stopPropagation();l.preventDefault();k.addClass("incoming")}).on("dragleave",function(l){l.stopPropagation();l.preventDefault();k.removeClass("incoming")}).on("drop",function(l){l.stopPropagation();l.preventDefault();k.removeClass("incoming").removeClass("active")})};$("#job_job_type_",f).change(function(){$("#job_form_messages",f).empty();if($(this).val()===""){}else{if($(this).val()==="report_job"){$("#job_form_messages",f).html(AS.renderTemplate("template_report_instructions"));$(".form-actions .btn-primary").addClass("disabled");$("#noImportTypeSelected",f).hide();$("#job_type_fields",f).empty().html(AS.renderTemplate("template_report_job",{id_path:"job_job_params_",path:"job[job_params]"}));$(".linker:not(.initialised)").linker();$(document).triggerHandler("subrecordcreated.aspace",["date",f]);$(".select-record",f).on("click",function(m){$(".accordion-toggle").click();$(".form-actions .btn-primary").removeClass("disabled");m.preventDefault();var l=$(this).data("report");var n=$(this).parent();$(this).siblings(".selected-message").removeClass("hide");$(this).addClass("hide");n.removeClass("alert-info").addClass("alert-success");n.parent().siblings(".report-listing").fadeOut("slow",function(){$(this).remove()})});a()}else{if($(this).val()==="print_to_pdf_job"){$("#noImportTypeSelected",f).hide();$("#job_type_fields",f).empty().html(AS.renderTemplate("template_print_to_pdf_job",{id_path:"print_to_pdf_job",path:"print_to_pdf_job"}));$(".linker:not(.initialised)").linker()}else{if($(this).val()==="find_and_replace_job"){$("#noImportTypeSelected",f).hide();$("#job_form_messages",f).html(AS.renderTemplate("template_find_and_replace_warning"));$("#job_type_fields",f).empty().html(AS.renderTemplate("template_find_and_replace_job",{id_path:"find_and_replace_job",path:"find_and_replace_job"}));var k=$("#find_and_replace_job_record_type_");var j=$("#find_and_replace_job_property_");$(".linker:not(.initialised)").linker();k.attr("disabled","disabled");j.attr("disabled","disabled");$("#find_and_replace_job_ref_").change(function(){var l=$(this).val();if(l.length){var m=/\d+$/.exec(l)[0];$.ajax({url:"/resources/"+m+"/models_in_graph",success:function(o){var n=k.val();k.empty();k.append($("<option>",{selected:true,disabled:true}).text(" -- select a record type --"));$.each(o,function(q,p){var r={value:p[0]};if(n===p[0]){r.selected=true}k.append($("<option>",r).text(p[1]))});k.removeAttr("disabled");if(n!=k.val()){k.triggerHandler("change")}}})}});k.change(function(){var l=$(this).val();$.ajax({url:"/schema/"+l+"/properties?type=string&editable=true",success:function(m){j.empty();$.each(m,function(o,n){j.append($("<option>",{value:n[0]}).text(n[1]))});j.removeAttr("disabled")}})})}else{if($(this).val()==="import_job"){$("#job_type_fields",f).empty().html(AS.renderTemplate("template_import_job",{id_path:"import_job",path:"import_job"})).slideDown();g();$("#job_import_type_",f).change(function(){if($(this).val()===""){$("#noImportTypeSelected",f).show();$("#job_filenames_",f).hide()}else{$("#noImportTypeSelected",f).hide();$("#job_filenames_",f).empty().append(AS.renderTemplate("template_fileupload")).slideDown();g()}});$("#job_import_type_",f).trigger("change")}}}}}});$("#job_job_type_",f).trigger("change");var h=function(j){$(".job-create-form-wrapper").replaceWith(j);b()};var d=$("#uploadProgress",f);var e=$(".bar",d);f.ajaxForm({type:"POST",beforeSubmit:function(j,k,l){$(".btn, a, :input",k).attr("disabled","disabled").addClass("disabled");d.show();c=$("#job_job_type_",k).val();if(c==="find_and_replace_job"){for(var m=0;m<j.length;m++){if(j[m].name==="find_and_replace_job[ref]"){j[m].name="find_and_replace_job[base_record_uri]"}}}else{if(c=="print_to_pdf_job"){for(var m=0;m<j.length;m++){if(j[m].name==="print_to_pdf_job[ref]"){j[m].name="print_to_pdf_job[source]"}}}else{if(c==="import_job"){console.log("ATTACH");$(".import-file.file-attached").each(function(){var n=$(this);console.log(n);j.push({name:"files[]",type:"file",value:n.data("file")})})}}}},uploadProgress:function(n,j,m,l){var k=l+"%";e.width(k)},success:function(m,k,n){var o;if(typeof m==="string"){var j=$(m);if(j.is("textarea")){if(j.data("type")==="html"){return h(j.val())}else{if(j.data("type")==="json"){o=JSON.parse(j.val()).uri}else{throw"jobs.crud: textarea.data-type not currently support - "+j.data("type")}}}else{throw"jobs.crud: the response text should be wrapped in a textarea for the plugin AjaxForm support"}}else{o=m.uri}var l="100%";e.width(l);d.removeClass("active").removeClass("progress-striped");e.addClass("bar-success");$("#successMessage").show();location.href=APP_PATH+"resolve/readonly?uri="+o},error:function(j){h(j.responseText)}})};var a=function(){$(document).on("change","#location_report_type",function(){var d=$(this).val();$(".report_type").hide();var e=$("#report_location_start");var c=$("#report_location_end");if(d==="single_location"){c.hide();e.find("label").text(e.data("singular-label"))}else{if(d==="location_range"){e.find("label").text(e.data("range-label"));c.find("label").text(c.data("range-label"));c.show()}}$(".report_type."+d).show()});$("#location_report_type").trigger("change")};b()});