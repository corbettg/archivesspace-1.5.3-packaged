$(function(){var d=10000;var b="stale";var c="opened_for_editing";var e="repository_changed";var a=function(h){if(h.data("update-monitor")==="enabled"){return}h.data("update-monitor","enabled");h.data("update-monitor-paused",false);var i=h.data("update-monitor-url");var j=h.data("update-monitor-lock_version");var k=h.data("update-monitor-record-uri");var g=h.data("update-monitor-record-is-stale");$(document).trigger("clearupdatemonitorintervals.aspace");var m=function(q){$(".record-pane .update-monitor-error",h).remove();if(g||q.status===b){var p=AS.renderTemplate(g?"update_monitor_save_failed_with_stale_record_template":"update_monitor_stale_record_message_template");$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p);$(".btn-primary, .btn-toolbar .btn",h).attr("disabled","disabled").addClass("disabled");clearInterval($(document).data("UPDATE_MONITOR_POLLING_INTERVAL"))}else{if(q.status===c){var n=[];$.each(q.edited_by,function(r,s){n.push(r)});var p=AS.renderTemplate("update_monitor_other_editors_message_template",{user_ids:n.join(", ")});$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p)}else{if(q.status===e){var p=AS.renderTemplate("update_monitor_repository_changed_message_template");$("#form_messages",h).prepend(p);$(".record-pane .form-actions",h).prepend(p)}}}if($(".as-nav-list li.alert-error").length===0){$(".as-nav-list").prepend(AS.renderTemplate("as_nav_list_errors_item_template"))}var o=$(".as-nav-list li.alert-error");if(!o.hasClass("acknowledged")&&$(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL")==null){$(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL",setInterval(function(){o.toggleClass("active")},3000));o.hover(function(){clearInterval($(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL"));o.removeClass("active").addClass("acknowledged")},function(){})}};var f=function(){$(".update-monitor-error",h).remove()};var l=function(){if(g){m();return}if(h.data("update-monitor-paused")==true){return}$.post(i,{lock_version:j,uri:k},function(n,p,o){if(n.status===b||n.status===c||n.status===e){m(n)}else{f()}},"json").fail(function(n,p,o){if(n.status===500||n.status===403){window.location.replace(FRONTEND_URL)}})};l();$(document).data("UPDATE_MONITOR_POLLING_INTERVAL",setInterval(l,d))};$(document).bind("setupupdatemonitor.aspace",function(g,f){a(f)});$(document).bind("clearupdatemonitorintervals.aspace",function(f){clearInterval($(document).data("UPDATE_MONITOR_HIGHLIGHT_INTERVAL"));clearInterval($(document).data("UPDATE_MONITOR_POLLING_INTERVAL"))})});AS.LoginHelper={init:function(a){$(a).each(function(){var c=$(this);var b=function(e){$(".form-group",c).removeClass("has-error");$(".alert-success",c).show();c.trigger("loginsuccess.aspace",[e])};var d=function(){$(".form-group",c).addClass("has-error");$(".alert-danger",c).show();$("#login",c).removeAttr("disabled");c.trigger("loginerror.aspace")};c.ajaxForm({dataType:"json",beforeSubmit:function(){$("#login",c).attr("disabled","disabled")},success:function(f,e,g){if(f.session){b(f)}else{d()}},error:function(g,f,e){d()}})})}};$(function(){var a=function(){$(this).each(function(){var b=$(this);var c=function(d){$.ajax({url:APP_PATH+"has_session",async:false,data_type:"json",success:function(f){if(f.has_session){return true}else{d.preventDefault();d.stopImmediatePropagation();$(":input[type='submit']",b).removeAttr("disabled");var h=$(".modal.initialised");if(h.length){h.hide()}var e=AS.openAjaxModal(APP_PATH+"login");e.removeClass("inline-login-modal");var g=$("form",e);AS.LoginHelper.init(g);g.on("loginsuccess.aspace",function(i,j){$(":input[name=authenticity_token]").val(j.csrf_token);if(h.length===0){b.unbind("submit",c);b.submit()}else{e.hide();e.remove();h.show()}e.on("hidden",function(){e.remove()});setTimeout(function(){e.modal("hide")},1000);return false});return false}},error:function(){$(":input[type='submit']",b).removeAttr("disabled");return true}})};b.on("submit",c)})};$(document).bind("loadedrecordform.aspace",function(b,c){$.proxy(a,c.find("form.aspace-record-form:not(.public-form)").andSelf().filter("form.aspace-record-form:not(.public-form)"))()});$.proxy(a,$("form.aspace-record-form:not(.public-form)"))()});$(function(){var c=function(){$(this).each(function(){$(".form-overlay",$(this)).height("100%").fadeIn();$(this).addClass("locked")})};var b=function(){$(this).each(function(){var e=$(AS.renderTemplate("form_overlay_unlock_template"));e.on("click",function(f){f.preventDefault();f.stopImmediatePropagation();$(window).trigger("hashchange")});$("#archives_form_overlay",$(this)).append(e);$(".alert",e).fadeIn()})};var d=[37,39,9];var a=function(){$(this).each(function(){var e=$(this);if(e.data("changedDetectionEnabled")){return}e.data("form_changed",e.data("form_changed")||false);e.data("changedDetectionEnabled",true);$("> .form-context > .row > .col-md-9",e).prepend('<div id="archives_form_overlay"><div class="modal-backdrop in form-overlay"></div></div>');$("> .form-context > .row > .col-md-3 .form-actions",e).prepend('<div id="archives_form_actions_overlay" class="modal-backdrop in form-overlay"></div>');var g=function(h){if($(h.target).parents("*[data-no-change-tracking='true']").length===0){e.trigger("formchanged.aspace");e.trigger("readonlytree.aspace")}};e.on("change keyup",":input",function(h){if($(this).data("original_value")&&($(this).data("original_value")!==$(this).val())){g(h)}else{if($.inArray(h.keyCode,d)===-1){g(h)}}});var f=function(i){i.preventDefault();var h=$("<input>").attr("type","hidden").attr("name","ignorewarnings").val("true");$("form.aspace-record-form").append($(h));$("form.aspace-record-form").submit();return false};e.on("click",":radio, :checkbox",g);e.on("formchanged.aspace",function(h){if(e.data("form_changed")===true){h.stopPropagation()}else{$(document).bind("keydown","ctrl+s",f);$(":input",h.target).bind("keydown","ctrl+s",f)}e.data("form_changed",true);$(".record-toolbar",e).addClass("formchanged");$(".record-toolbar .btn-toolbar .btn",e).addClass("disabled").attr("disabled","disabled")});$(".createPlusOneBtn",e).on("click",function(){e.data("createPlusOne","true")});e.bind("submit",function(h){e.data("form_changed",false);e.data("update-monitor-paused",true);e.off("change keyup formchanged.aspace");$(document).unbind("keydown",f);$(":input[type='submit'], :input.btn-primary",e).attr("disabled","disabled");if($(this).data("createPlusOne")){var i=$("<input>").attr("type","hidden").attr("name","plus_one").val("true");$(e).append(i)}return true});$(".record-toolbar .revert-changes .btn",e).click(function(){e.data("form_changed",false);return true});$(".form-actions .btn-cancel",e).click(function(){e.data("form_changed",false);return true});$(window).bind("beforeunload",function(h){if(e.data("form_changed")===true){return"Please note you have some unsaved changes."}});if(e.data("update-monitor")){$(document).trigger("setupupdatemonitor.aspace",[e])}else{if(e.closest(".modal").length===0){$(document).trigger("clearupdatemonitorintervals.aspace",[e])}}})};$(document).bind("loadedrecordform.aspace",function(e,f){$.proxy(a,$("form.aspace-record-form",f))()});$(document).bind("lockform.aspace",function(e,f){$.proxy(c,[f])()});$(document).bind("unlockform.aspace",function(e,f){$.proxy(b,[f])()});$.proxy(a,$("form.aspace-record-form"))()});$(function(){var d=function(f){var e=false;$("option.group-member").each(function(g,h){if($(h).val().toLowerCase()===f.toLowerCase()){e=true;return false}});return e};var a=function(h){if($(h.target).attr("id")=="new-member"){if(((h.keyCode||h.which)!=13)||$(".typeahead.dropdown-menu:visible",".member-toolbar").length>0){return}}h.stopPropagation();h.preventDefault();var f=$("#new-member");var i=f.val();if(!i||d(i)){return}var g=$('<option class="group-member" />').attr("value",i).text(i);$("#group_member_usernames_").append(g);f.val("")};var c=function(f){f.preventDefault();$(":selected","#group_member_usernames_").remove();$("#remove-member").attr("disabled","disabled")};$("form#new_group").submit(function(h){var g=$(h.target);$("#hidden_member_fields",g).remove();var f=$('<div style="display: none" id="hidden_member_fields" />');$("#group_member_usernames_ option").each(function(e,j){var i=$('<input type="hidden" name="group[member_usernames][]" />');i.val($(j).val());f.append(i)});g.append(f);return true});$("#add-new-member").click(a);$("#new-member").keydown(a);$("#remove-member").click(c);$("#group_member_usernames_").change(function(f){if($(":selected",f.target).length>0){$("#remove-member").removeAttr("disabled")}else{$("#remove-member").attr("disabled","disabled")}});var b=AS.delayedTypeAhead(function(e,f){$.ajax({url:APP_PATH+"users/complete",data:{query:e},type:"GET",success:function(g){f(g)},error:function(){f([])}})});$("#new-member").typeahead({source:b.handle})});